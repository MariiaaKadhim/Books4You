<%- include('../partials/header') %>

<h1> Book Details</h1>

<span>
  <a href="/lists/<%=book._id%>">Add to my books list</a>
</span>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Category</th>
      <th>Author</th>
      <th>Publish Date</th>
      <th>Summary</th>
      <th>Poster</th>
      <th>Available at</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><%= book.name %></td>
      <td><%= book.category %></td>
      <td><%= book.author %></td>
      <td><%= book.publishDate.toLocaleDateString() %></td>
      <td><%= book.summary %></td>
      <td><img src="<%= book.poster %>" alt="<%= book.name %> poster"></td>
      <td><a href="<%= book.available %>"><%= book.available %></a></td>
      <td><%= book.review %></td>
    </tr>
  </tbody>
</table>

<% if (user) { %>
  <% if (user.type) { %>
    <a href="/admins/<%= book._id %>/edit">
      <button>Edit book</button>
    </a>

    <form id="delete-form" action="/admins/<%= book._id %>?_method=DELETE" method="POST">
      <button type="submit" class="delete-book">Delete Book</button>
    </form>
  <% } %>
<% } %>

<br><br>
<h2>Reviews</h2>
<form id="add-review-form" method="POST" action="/books/<%= book._id %>/reviews">
  <label>Review:</label>
  <textarea name="content"></textarea>
  <input type="submit" value="Add Review">
</form>

<% if (book.reviews.length) { {%>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Review</th>
      </tr>
    </thead>
    <tbody>
      <% book.reviews.forEach(function(review) { %>
        <tr>
          <td><%= review.createdAt.toLocaleDateString() %></td>
          <td><%= review.content %></td>
          <td>
            <% if (user.type) { %> 
              <form action="/books/show/<%= review.id %>/reviews?_method=DELETE" method="POST">
                <input type="hidden" name="bookId" value=<%= book._id %>>
                <button type="submit">X</button>
                  </form>
                <% } %>
              <% }) %>
            <% } %>
          </td>
        </tr>
    </tbody>
  </table>
<% } else { %>
  <h5>No Reviews Yet</h5>
<% } %>

<script>
  const confirm = (event) => {
    event.preventDefault();
    const confirmDiv = document.createElement('div');
    confirmDiv.classList.add('confirm-dialog');
    
    confirmDiv.innerHTML = `
      <p>Are you sure you want to delete this book?</p>
      <button id="confirm-yes">Yes</button>
      <button id="confirm-no">No</button>
    `;
    document.body.appendChild(confirmDiv);

    const confirmYes = document.getElementById('confirm-yes');
    const confirmNo = document.getElementById('confirm-no');
    
    confirmYes.addEventListener('click', () => {
      document.body.removeChild(confirmDiv);
      document.getElementById('delete-form').submit();
    });

    confirmNo.addEventListener('click', () => {
      document.body.removeChild(confirmDiv);
    });
  }

  document.querySelector(".delete-book").addEventListener("click", confirm);
</script>

<%- include('../partials/footer') %>
